{
  "variables" : {
    "http_proxy"  : "{{env `http_proxy`}}",
    "https_proxy" : "{{env `https_proxy`}}",
    "no_proxy"    : "{{env `no_proxy`}}"
  },


  "builders": [
    {
      "type" : "virtualbox-iso",
      "guest_os_type" : "ArchLinux_64",
      "iso_url" : "http://mirror.rackspace.com/archlinux/iso/latest/archlinux-{{isotime \"2006.01\"}}.01-x86_64.iso",
      "iso_checksum" : "file:http://mirror.rackspace.com/archlinux/iso/latest/md5sums.txt",
      "boot_command" : "<tab><end> cow_spacesize=1G<enter><wait60>systemctl start sshd && mkdir -m 0700 /root/.ssh && echo '{{.SSHPublicKey}}' >> /root/.ssh/authorized_keys<enter>",
      "guest_additions_mode" : "disable",
      "shutdown_command" : "poweroff",
      "ssh_username" : "root",
      "ssh_clear_authorized_keys" : true,
      "memory" : "2048",
      "disk_size" : 65536,
      "hard_drive_interface" : "sata",
      "iso_interface" : "sata",
      "vboxmanage": [
        ["modifyvm", "{{.Name}}", "--nictype1", "virtio"],
        ["modifyvm", "{{.Name}}", "--vram", "16"],
        ["modifyvm", "{{.Name}}", "--rtcuseutc", "on"],
        ["storagectl", "{{.Name}}", "--name", "IDE Controller", "--remove"]
      ]
    },
    {
      "type" : "qemu",
      "iso_url" : "http://mirror.rackspace.com/archlinux/iso/latest/archlinux-{{isotime \"2006.01\"}}.01-x86_64.iso",
      "iso_checksum" : "file:http://mirror.rackspace.com/archlinux/iso/latest/md5sums.txt",
      "vm_name" : "archlinux.qcow2",
      "shutdown_command" : "poweroff",
      "ssh_username" : "root",
      "ssh_clear_authorized_keys" : true,
      "memory" : "2048",
      "disk_size" : 65536,
      "ssh_private_key_file": "./insecure_key",
      "disk_interface": "virtio-scsi",
      "qemuargs" : [
        ["-vga", "virtio"]
      ],
      "boot_command" : [
        "<tab><end> cow_spacesize=1G<enter>",
        "<wait60>systemctl start sshd && mkdir -m 0700 /root/.ssh<enter>",
        "echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMxWY/8/m23+oBuOdC8YH7SdhaRdTQ0fRqcL8O3EaIUX TempKey' >> /root/.ssh/authorized_keys<enter>"
      ]
    }
  ],

  "provisioners" : [
    {
      "type" : "shell",
      "script" : "prepare.sh",
      "environment_vars" : [
        "http_proxy={{user `http_proxy`}}",
        "https_proxy={{user `https_proxy`}}",
        "no_proxy={{user `no_proxy`}}"
      ]
    },
    {
      "type" : "ansible-local",
      "playbook_dir" : "../ansible",
      "playbook_file" : "../ansible/site.yaml",
      "extra_arguments" : [
        "--skip-tags=reboot", "--tags=bootstrap",
        "-e", "http_proxy={{user `http_proxy`}}",
        "-e", "https_proxy={{user `https_proxy`}}",
        "-e", "no_proxy={{user `no_proxy`}}"
      ]
    },
    {
      "type" : "shell",
      "inline" : "reboot",
      "expect_disconnect" : true
    },
    {
      "type" : "shell",
      "pause_before" : "3m",
      "script" : "prepare.sh",
      "environment_vars" : [
        "http_proxy={{user `http_proxy`}}",
        "https_proxy={{user `https_proxy`}}",
        "no_proxy={{user `no_proxy`}}"
      ]
    },
    {
      "type" : "ansible-local",
      "playbook_dir" : "../ansible",
      "playbook_file" : "../ansible/site.yaml",
      "extra_arguments" : [
        "--skip-tags=reboot", "--tags=mainconfig",
        "-e", "http_proxy={{user `http_proxy`}}",
        "-e", "https_proxy={{user `https_proxy`}}",
        "-e", "no_proxy={{user `no_proxy`}}",
        "-e", "global_portable_image=True"
      ]
    },
    {
      "type" : "shell",
      "script" : "clean.sh"
    }
  ],

  "_modeline":" vi: set sw=2 sts=-1 et:"
}
